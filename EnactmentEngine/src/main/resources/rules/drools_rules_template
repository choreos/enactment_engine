import it.cnr.isti.labsedc.glimpse.event.GlimpseBaseEventChoreos;
import it.cnr.isti.labsedc.glimpse.manager.ResponseDispatcher;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

declare GlimpseBaseEventChoreos
	@role( event )
	@timestamp( timeStamp )
end

declare ResponseTimeEvent
	@role(event)
	@expires (2m)
	value : float
	ip : String
	service: String
	chor: String
end

declare CpuUserEvent
	@role(event)
	@expires (2m)
	value : float
	ip : String
end

declare AddReplica
	@role(event)
	@expires( 5m )
	service : String
end

declare RemReplica
	@role(event)
	@expires ( 3m )
	ip : String
end

rule "CpuUser"
no-loop true
salience 100
dialect "mvel"

when
	$aEvent : GlimpseBaseEventChoreos(
		this.isConsumed == false,
		this.isException == false,
		this.getEventName == "cpu_user"
	);
then
	$aEvent.setConsumed(true);
	update($aEvent);
	Pattern p = Pattern.compile("Measured: ([0-9.]+)");
	Matcher m1 = p.matcher((String) $aEvent.getEventData());
	float f = -1;
	if (m1.find())
		f = Float.parseFloat(m1.group(0).split(": ")[1]);
	insert (new CpuUserEvent(f,$aEvent.getMachineIP()));
	ResponseDispatcher.LogViolation(
		"\nRule name: " + drools.getRule().getName(),
		"\nFrom: Resource Metric Aggregator",
		"\nSLA resource measurement: " + (String) $aEvent.getMachineIP() + " " + f);
end

rule "LowCpuUser"
no-loop true
salience 10
dialect "mvel"

when
	$ev : CpuUserEvent();
	$rs : Number(@{min_cpu_usage} > doubleValue) from accumulate(
		CpuUserEvent($ev.ip == ip, $val : value),
			average($val)
	);
	not RemReplica(ip == $ev.ip);
then
	insert(new RemReplica($ev.ip));
	ResponseDispatcher.LogViolation(drools.getRule().getName(),
		"QoS Drools Rules",
		"\nSLA QoS violation detected on: " + $ev.ip);
	ResponseDispatcher.NotifyMeValue(drools.getRule().getName(),
		"eeConsumer", (String) $ev.ip, "all");
end


@{services_rules}

