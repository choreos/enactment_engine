
		rule "DetectHighResponseTime"
		no-loop true
		salience 300

		when
			$ev : ResponseTimeEvent();
			
			$depFc : DeployStatus(instance == $ev.instance);
	
			ResponseTimeEvent(instance == $ev.instance, this before[45s,1m] $ev);

			$sla : SLA(metric == "max_response_time", service_or_ip == $depFc.service);
			
			$pol : Policy(service == $depFc.service);
			
			Number( $eventSum : doubleValue ) from accumulate(
				$event : ResponseTimeEvent($ev.instance == instance) over window:time( 30s ),
					count($event)
			);
			
			Number( intValue > $eventSum * 0.05 ) from accumulate(
				$sEvent : ResponseTimeEvent(value > 1000, $ev.instance == instance) over window:time( 30s ),
						count($sEvent)
			);
			
			not ReconfProcess(service == $depFc.service);
			not FinishedUpdate(service == $depFc.service);

		then
			HighResponseTime $hrt = new HighResponseTime($depFc.getIp(), $depFc.getService(), $pol.getPolicy());
			insert ( $hrt );
		end
		